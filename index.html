<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Routing with LRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    #map {
      height: 100vh;
    }
    .floating-box {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      font-family: sans-serif;
    }
    .floating-box input {
      width: 200px;
      margin: 2px 0;
    }
    .waypoint-row {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
      align-items: center;
    }
    .remove-btn {
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .status-msg {
      color: #0066cc;
      margin-top: 5px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="floating-box" id="controlBox">
    <button id="startBtn">ค้นหาเส้นทาง</button>
    <div id="inputRows"></div>
    <div class="status-msg" id="statusMsg"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <script>
    const map = L.map('map').setView([13.75, 100.5], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let isRouting = false;
    let waypoints = [];
    let control = null;
    let popupDistance = null;

    const inputRows = document.getElementById('inputRows');
    const statusMsg = document.getElementById('statusMsg');
    const startBtn = document.getElementById('startBtn');

    function addInputRow(label, latlng, isRemovable = false) {
      const row = document.createElement('div');
      row.className = 'waypoint-row';
      row.innerHTML = `
        <label>${label}:</label>
        <input type="text" class="lat-input" value="${latlng.lat.toFixed(6)}">
        <input type="text" class="lng-input" value="${latlng.lng.toFixed(6)}">
        ${isRemovable ? '<button class="remove-btn">×</button>' : ''}
      `;
      inputRows.appendChild(row);

      if (isRemovable) {
        row.querySelector('.remove-btn').onclick = () => {
          const idx = Array.from(inputRows.children).indexOf(row);
          waypoints.splice(idx, 1);
          inputRows.removeChild(row);
          drawRoute();
        };
      }

      row.querySelector('.lat-input').onchange = row.querySelector('.lng-input').onchange = () => {
        const idx = Array.from(inputRows.children).indexOf(row);
        const lat = parseFloat(row.querySelector('.lat-input').value);
        const lng = parseFloat(row.querySelector('.lng-input').value);
        if (!isNaN(lat) && !isNaN(lng)) {
          waypoints[idx] = L.latLng(lat, lng);
          drawRoute();
        }
      };
    }

    map.on('click', (e) => {
      if (!isRouting) return;

      if (waypoints.length === 0) {
        waypoints.push(e.latlng);
        addInputRow("จุดเริ่ม", e.latlng);
        showInstruction("คลิกจุดหมายต่อไป");

      } else if (waypoints.length === 1) {
        waypoints.push(e.latlng);
        addInputRow("จุดหมาย", e.latlng);
        drawRoute();
        showInstruction("คลิกเพิ่มจุดทางผ่าน (ได้ 1 จุด) หรือปรับลากเส้นทาง");

      } else if (waypoints.length === 2) {
        waypoints.splice(1, 0, e.latlng); // แทรกทางผ่านก่อนปลายทาง
        addInputRow("ทางผ่าน", e.latlng, true);
        drawRoute();
        showInstruction("ลากจุดหรือแก้ไขเพื่อปรับเส้นทาง");
      }
    });

    startBtn.onclick = () => {
      if (!isRouting) {
        isRouting = true;
        startBtn.innerText = "รีเซ็ต";
        showInstruction("คลิกจุดเริ่มต้น แล้วคลิกจุดหมาย จากนั้นค่อยเลือกจุดทางผ่านหรือปรับลากเปลี่ยนเส้นทาง");
        waypoints = [];
        inputRows.innerHTML = "";
        if (control) map.removeControl(control);
        if (popupDistance) map.removeLayer(popupDistance);
      } else {
        location.reload(); // รีเซ็ตง่าย ๆ
      }
    };

    function showInstruction(msg) {
      statusMsg.innerHTML = msg;
    }

    function drawRoute() {
      if (control) map.removeControl(control);
      if (popupDistance) map.removeLayer(popupDistance);

      control = L.Routing.control({
        waypoints: waypoints,
        show: false,
        collapsible: false,
        routeWhileDragging: true,
        createMarker: function(i, wp) {
          return L.marker(wp.latLng, { draggable: true })
            .on('dragend', function(e) {
              waypoints[i] = e.target.getLatLng();
              updateInputs();
              drawRoute();
            });
        },
        altLineOptions: [
          { styles: [{color: 'skyblue', opacity: 0.7, weight: 5}] },
          { styles: [{color: 'gold', opacity: 0.7, weight: 5}] }
        ],
        lineOptions: {
          styles: [{color: 'blue', opacity: 1, weight: 6}]
        }
      }).addTo(map);

      control.on('routesfound', function(e) {
        const summary = e.routes[0].summary;
        const altSummary = e.routes[1] ? e.routes[1].summary : null;

        let msg = `ระยะทาง : ${(summary.totalDistance / 1000).toFixed(2)} กม.<br>`;
        msg += `เวลา : ${formatTime(summary.totalTime)}`;
        if (altSummary) {
          msg += `<hr>เส้นทางสำรอง:<br>`;
          msg += `ระยะทาง : ${(altSummary.totalDistance / 1000).toFixed(2)} กม.<br>`;
          msg += `เวลา : ${formatTime(altSummary.totalTime)}`;
        }

        popupDistance = L.popup()
          .setLatLng(e.routes[0].coordinates[Math.floor(e.routes[0].coordinates.length / 2)])
          .setContent(`<div style="font-size:14px">${msg}</div>`)
          .openOn(map);

        showInstruction(""); // ล้างข้อความแนะนำ
      });
    }

    function updateInputs() {
      [...inputRows.children].forEach((row, i) => {
        row.querySelector('.lat-input').value = waypoints[i].lat.toFixed(6);
        row.querySelector('.lng-input').value = waypoints[i].lng.toFixed(6);
      });
    }

    function formatTime(t) {
      const h = Math.floor(t / 3600);
      const m = Math.round((t % 3600) / 60);
      return `${h > 0 ? h + ' ชม. ' : ''}${m} นาที`;
    }
  </script>
</body>
</html>

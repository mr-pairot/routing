<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet Routing with Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
  />
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { height: 85vh; }

    .form-box {
      padding: 10px;
      background: #f4f4f4;
      border-bottom: 1px solid #ccc;
    }

    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .form-row input {
      margin-left: 5px;
      width: 150px;
    }

    .remove-btn {
      margin-left: 10px;
      background: red;
      color: white;
      border: none;
      cursor: pointer;
    }

    .info-message {
      color: #0077cc;
      font-weight: bold;
      padding-top: 5px;
    }

    .route-popup {
      font-size: 14px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="form-box">
    <div class="form-row">
      ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°:
      <input type="text" id="startLat" placeholder="Lat">
      <input type="text" id="startLng" placeholder="Lng">
    </div>
    <div class="form-row">
      ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢:
      <input type="text" id="endLat" placeholder="Lat">
      <input type="text" id="endLng" placeholder="Lng">
    </div>
    <div id="viaRowContainer"></div>
    <div id="message" class="info-message"></div>
    <button id="routeBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script>
    const map = L.map('map').setView([13.75, 100.5], 8);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let isSelecting = false;
    let waypoints = [];
    let routingControl = null;
    let routePopup = null;

    const routeBtn = document.getElementById("routeBtn");
    const messageEl = document.getElementById("message");
    const viaRowContainer = document.getElementById("viaRowContainer");

    function resetForm() {
      document.getElementById("startLat").value = "";
      document.getElementById("startLng").value = "";
      document.getElementById("endLat").value = "";
      document.getElementById("endLng").value = "";
      viaRowContainer.innerHTML = "";
    }

    function updateInputs() {
      if (waypoints[0]) {
        document.getElementById("startLat").value = waypoints[0].lat;
        document.getElementById("startLng").value = waypoints[0].lng;
      }
      if (waypoints[1]) {
        document.getElementById("endLat").value = waypoints[waypoints.length - 1].lat;
        document.getElementById("endLng").value = waypoints[waypoints.length - 1].lng;
      }
      if (waypoints.length === 3) {
        const via = waypoints[1];
        addViaRow(via.lat, via.lng);
      }
    }

    function addViaRow(lat, lng) {
      viaRowContainer.innerHTML = '';
      const row = document.createElement('div');
      row.className = 'form-row';
      row.innerHTML = `
        ‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô:
        <input type="text" class="viaLat" value="${lat || ''}" placeholder="Lat">
        <input type="text" class="viaLng" value="${lng || ''}" placeholder="Lng">
        <button class="remove-btn" onclick="removeViaPoint()">‚úï</button>
      `;
      viaRowContainer.appendChild(row);
    }

    window.removeViaPoint = function () {
      if (waypoints.length === 3) {
        waypoints.splice(1, 1);
        viaRowContainer.innerHTML = '';
        drawRoute();
      }
    }

    function showPopup(latlng, html) {
      L.popup().setLatLng(latlng).setContent(html).openOn(map);
    }

    function drawRoute() {
      if (routingControl) {
        map.removeControl(routingControl);
      }

      routingControl = L.Routing.control({
        waypoints: waypoints.map(wp => L.latLng(wp.lat, wp.lng)),
        lineOptions: {
          styles: [
            { color: 'blue', weight: 6 },
            { color: 'lightblue', weight: 3 },
            { color: 'orange', weight: 2 }
          ]
        },
        altLineOptions: {
          styles: [
            { color: 'lightblue', weight: 3 },
            { color: 'yellow', weight: 2 }
          ]
        },
        show: false,
        draggableWaypoints: true,
        addWaypoints: false
      }).on('routesfound', function (e) {
        const routes = e.routes;
        const popupContent = routes.map((r, idx) => {
          const dist = (r.summary.totalDistance / 1000).toFixed(2);
          const timeMin = Math.floor(r.summary.totalTime / 60);
          const hours = Math.floor(timeMin / 60);
          const minutes = timeMin % 60;
          return `<div class="route-popup"><b>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ${idx + 1}</b>: ${dist} ‡∏Å‡∏°. - ${hours} ‡∏ä‡∏°. ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ</div>`;
        }).join("");

        if (routePopup) map.closePopup(routePopup);
        routePopup = L.popup().setLatLng(routes[0].coordinates[Math.floor(routes[0].coordinates.length / 2)])
          .setContent(popupContent)
          .openOn(map);
        messageEl.innerHTML = '';
      }).addTo(map);
    }

    map.on('click', function (e) {
      if (!isSelecting) return;

      if (waypoints.length === 0) {
        waypoints.push(e.latlng);
        showPopup(e.latlng, "üö© ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");

      } else if (waypoints.length === 1) {
        waypoints.push(e.latlng);
        showPopup(e.latlng, "üèÅ ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢");

      } else if (waypoints.length === 2) {
        waypoints.splice(1, 0, e.latlng); // ‡πÅ‡∏ó‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2 (‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô)
        showPopup(e.latlng, "üö∂ ‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô");
        addViaRow(e.latlng.lat, e.latlng.lng);
      }
      updateInputs();
      if (waypoints.length >= 2) drawRoute();
    });

    routeBtn.addEventListener('click', function () {
      if (!isSelecting) {
        isSelecting = true;
        waypoints = [];
        resetForm();
        messageEl.innerHTML = "üëâ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á";
        routeBtn.textContent = "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï";

        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        if (routePopup) {
          map.closePopup(routePopup);
          routePopup = null;
        }
      } else {
        isSelecting = false;
        waypoints = [];
        resetForm();
        messageEl.innerHTML = "";
        routeBtn.textContent = "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á";

        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        if (routePopup) {
          map.closePopup(routePopup);
          routePopup = null;
        }
      }
    });
  </script>
</body>
</html>

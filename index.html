<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet Routing - Custom Popup + Multi Waypoint</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; }

    #controlBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: #0078D4;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    #info {
      position: absolute;
      top: 60px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      min-width: 250px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      font-size: 14px;
      line-height: 1.5;
    }

    .popup-box {
      font-size: 14px;
      padding: 6px 10px;
      color: #222;
    }

    .popup-box span {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      background: #f0f0f0;
      font-weight: bold;
    }
  </style>
</head>
<body>

<button id="controlBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
<div id="info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
  const map = L.map('map').setView([13.75, 100.5], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const controlBtn = document.getElementById('controlBtn');
  const infoDiv = document.getElementById('info');

  let waypoints = [];
  let routingControl = null;
  let isSelecting = false;

  function formatRouteSummary(route) {
    const distanceKm = (route.summary.totalDistance / 1000).toFixed(2);
    const durationMin = (route.summary.totalTime / 60).toFixed(1);
    return `‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${distanceKm} km<br>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á: ${durationMin} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  }

  function createPopupHtml(label) {
    return `<div class="popup-box"><span>${label}</span></div>`;
  }

  function resetRouting() {
    waypoints = [];
    isSelecting = false;

    if (routingControl) {
      map.removeControl(routingControl);
      routingControl = null;
    }

    infoDiv.innerHTML = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢";
    controlBtn.innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á";
  }

  controlBtn.addEventListener('click', () => {
    if (isSelecting || routingControl) {
      resetRouting();
    } else {
      isSelecting = true;
      showPopup(map.getCenter(), "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");
    }
  });

  function showPopup(latlng, message) {
    L.popup()
      .setLatLng(latlng)
      .setContent(createPopupHtml(message))
      .openOn(map);
  }

  map.on('click', function (e) {
    if (!isSelecting) return;

    waypoints.push(e.latlng);
    let label = "";

    if (waypoints.length === 1) {
      label = "üö© ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô";
    } else if (waypoints.length === 2) {
      label = "üèÅ ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢";
    } else {
      label = `‡∏à‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô ${waypoints.length - 2}`;
    }

    L.popup()
      .setLatLng(e.latlng)
      .setContent(createPopupHtml(label))
      .openOn(map);

    if (waypoints.length >= 2) {
      drawRoute();
      controlBtn.innerText = "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï";
    }
  });

  function drawRoute() {
    if (routingControl) {
      map.removeControl(routingControl);
    }

    routingControl = L.Routing.control({
      waypoints: waypoints,
      routeWhileDragging: true,
      showAlternatives: true,
      altLineOptions: [
        {
          styles: [{ color: 'deepskyblue', opacity: 0.7, weight: 4 }] // ‡∏™‡∏≥‡∏£‡∏≠‡∏á 1
        },
        {
          styles: [{ color: 'gold', opacity: 0.7, weight: 4 }] // ‡∏™‡∏≥‡∏£‡∏≠‡∏á 2
        }
      ],
      lineOptions: {
        styles: [{ color: 'blue', opacity: 1, weight: 5 }] // ‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏Å
      },
      createMarker: function (i, wp, nWps) {
        let label = i === 0 ? "üö© ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"
                 : i === nWps - 1 ? "üèÅ ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢"
                 : `‡∏à‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô ${i}`;
        return L.marker(wp.latLng, { draggable: true })
          .bindPopup(createPopupHtml(label));
      }
    })
    .on('routesfound', function (e) {
      const routes = e.routes;
      let summaryHtml = '';
      routes.forEach((route, i) => {
        const color = i === 0 ? 'blue' : i === 1 ? 'deepskyblue' : 'gold';
        summaryHtml += `<div><strong style="color:${color}">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ${i + 1}</strong><br>${formatRouteSummary(route)}</div><hr>`;
      });
      infoDiv.innerHTML = `<strong>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</strong><br>${summaryHtml}`;
    })
    .on('waypointschanged', function () {
      infoDiv.innerHTML = `<strong>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</strong><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà...`;
    })
    .addTo(map);
  }
</script>

</body>
</html>

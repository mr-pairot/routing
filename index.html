<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Routing with Control Button</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    #map { height: 100vh; }
    .routing-button {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .routing-button.reset {
      background: #f44336;
    }
    .custom-popup {
      font-family: 'Segoe UI', sans-serif;
      font-size: 14px;
      padding: 6px 10px;
      background-color: #f9f9f9;
      border-left: 4px solid #4CAF50;
    }
    #info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font-family: sans-serif;
      font-size: 14px;
      max-width: 300px;
    }
  </style>
</head>
<body>

<button id="routeBtn" class="routing-button">ค้นหาเส้นทาง</button>
<div id="info">กดปุ่มเพื่อเริ่มค้นหาเส้นทาง</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
  const map = L.map('map').setView([13.75, 100.5], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let routingActive = false;
  let startPoint = null;
  let endPoint = null;
  let routingControl = null;

  const routeBtn = document.getElementById('routeBtn');
  const infoDiv = document.getElementById('info');

  routeBtn.addEventListener('click', function () {
    if (!routingActive) {
      routingActive = true;
      routeBtn.innerText = "รีเซ็ต";
      routeBtn.classList.add('reset');
      infoDiv.innerHTML = "คลิกจุดเริ่มต้น และคลิกจุดหมายบนแผนที่";
    } else {
      resetRouting();
    }
  });

  function resetRouting() {
    routingActive = false;
    startPoint = null;
    endPoint = null;
    routeBtn.innerText = "ค้นหาเส้นทาง";
    routeBtn.classList.remove('reset');
    infoDiv.innerHTML = "กดปุ่มเพื่อเริ่มค้นหาเส้นทาง";
    if (routingControl) {
      map.removeControl(routingControl);
      routingControl = null;
    }
    map.eachLayer(layer => {
      if (layer instanceof L.Marker && !layer._icon.classList.contains('leaflet-marker-draggable')) {
        map.removeLayer(layer);
      }
    });
  }

  map.on('click', function(e) {
    if (!routingActive) return;

    if (!startPoint) {
      startPoint = e.latlng;
      L.popup({ className: 'custom-popup' })
        .setLatLng(startPoint)
        .setContent("<strong>จุดเริ่มต้น</strong>")
        .openOn(map);
    } else if (!endPoint) {
      endPoint = e.latlng;
      L.popup({ className: 'custom-popup' })
        .setLatLng(endPoint)
        .setContent("<strong>จุดหมาย</strong>")
        .openOn(map);
      drawRoute();
    }
  });

  function drawRoute() {
    if (routingControl) map.removeControl(routingControl);

    routingControl = L.Routing.control({
      waypoints: [startPoint, endPoint],
      routeWhileDragging: true,
      showAlternatives: true,
      altLineOptions: {
        styles: [{ color: 'gray', opacity: 0.7, weight: 4 }]
      },
      createMarker: function(i, wp, nWps) {
        return L.marker(wp.latLng, { draggable: true })
          .bindPopup(`<div class="custom-popup"><strong>${i === 0 ? 'จุดเริ่มต้น' : 'จุดหมาย'}</strong></div>`);
      }
    })
    .on('routesfound', function(e) {
      const routes = e.routes;
      let html = '';
      routes.forEach((route, i) => {
        const km = (route.summary.totalDistance / 1000).toFixed(2);
        const min = (route.summary.totalTime / 60).toFixed(1);
        html += `<strong>เส้นทาง ${i + 1}</strong>: ${km} กม. / ${min} นาที<br>`;
      });
      infoDiv.innerHTML = html;
    })
    .on('waypointschanged', () => {
      infoDiv.innerHTML = "กำลังคำนวณเส้นทางใหม่...";
    })
    .addTo(map);
  }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Leaflet Routing Map ปรับปรุง</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
     #map {
      height: 100vh;
    }
    .floating-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      width: 300px;
      font-family: sans-serif;
    }
    .floating-panel input {
      width: 100%;
      margin-bottom: 8px;
      padding: 5px;
      border: 1px solid #ccc;
    }
    .remove-btn {
      float: right;
      color: red;
      cursor: pointer;
    }
    .instruction {
      margin-top: 10px;
      color: #0047ab;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="floating-panel">
    <button id="routeBtn">ค้นหาเส้นทาง</button>
    <div id="coord-inputs"></div>
    <div id="showInstruction" class="instruction"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script>
    const map = L.map('map').setView([13.7367,100.523],13);
    let routeControl = null, waypoints = [], markers = [], mode = 'idle';
    const routeBtn = document.getElementById('routeBtn');
    const coordInputs = document.getElementById('coord-inputs');
    const showInstruction = document.getElementById('showInstruction');

    routeBtn.onclick = () => {
      if (mode === 'idle') {
        mode = 'selecting'; routeBtn.textContent = 'รีเซ็ต';
        waypoints = []; markers.forEach(m=>map.removeLayer(m)); markers=[];
        coordInputs.innerHTML = ''; showInstruction.innerHTML = 'คลิกจุดเริ่มต้น แล้วคลิกจุดหมาย จากนั้นเลือกทางผ่านหรือปรับลาก';
        if (routeControl) map.removeControl(routeControl), routeControl = null;
      } else resetAll();
    };

    map.on('click',(e)=>{
      if (mode!=='selecting' || waypoints.length>=3) return;
      const m = L.marker(e.latlng,{draggable: true}).addTo(map);
      markers.push(m);

      if (waypoints.length === 0) {
        waypoints.push(e.latlng);
      } else if (waypoints.length === 1) {
        waypoints.push(e.latlng);
      } else { // มีแล้ว 2 จุด
        waypoints.splice(1,0,e.latlng);
      }

      const idx = markers.length - 1;
      m.on('dragend', ()=>{
        const newLatLng = m.getLatLng();
        // หา index ของ marker ใน array by matching reference
        const i = markers.indexOf(m);
        if (i>=0 && i<waypoints.length) {
          waypoints[i] = newLatLng;
          updateInputs();
          drawRoute();
        }
      });

      updateInputs();
      drawRoute();
    });

    function updateInputs(){
      coordInputs.innerHTML = '';
      waypoints.forEach((pt,i)=>{
        const label = i===0 ? 'จุดเริ่ม :' : i===1 ? 'จุดหมาย :' : 'ทางผ่าน :';
        const row = document.createElement('div');
        row.innerHTML = `${label}
          <input type="text" value="${pt.lat.toFixed(6)}, ${pt.lng.toFixed(6)}" data-idx="${i}">
          ${i===2?'<span class="remove-btn" onclick="removeVia()">✖</span>':''}`;
        coordInputs.appendChild(row);
      });
      coordInputs.querySelectorAll('input').forEach(inp=>{
        inp.onchange = e=>{
          const i = +e.target.dataset.idx;
          const [lat,lng] = e.target.value.split(',').map(v=>parseFloat(v));
          if (!isNaN(lat)&&!isNaN(lng)) {
            waypoints[i] = L.latLng(lat,lng);
            markers[i].setLatLng(waypoints[i]);
            drawRoute();
          }
        }
      });
    }

    window.removeVia = ()=>{
      if (waypoints.length<3) return;
      map.removeLayer(markers[2]);
      markers.splice(2,1);
      waypoints.splice(2,1);
      updateInputs();
      drawRoute();
    };

    function drawRoute(){
      if (waypoints.length<2) return;
      if (routeControl) map.removeControl(routeControl), routeControl = null;

      const ordered = waypoints.length===3 ? [waypoints[0],waypoints[2],waypoints[1]] : [waypoints[0],waypoints[1]];

      routeControl = L.Routing.control({
        waypoints: ordered, routeWhileDragging:true, showAlternatives:true,
        createMarker: ()=>null,
        altLineOptions:[
          {styles:[{color:'deepskyblue',opacity:0.7,weight:5}]},
          {styles:[{color:'gold',opacity:0.7,weight:5}]}
        ],
        lineOptions:{styles:[{color:'blue',opacity:1,weight:6}]}
      }).on('routesfound',e=>{
        showInstruction.innerHTML = ''; 
        e.routes.forEach((route,idx)=>{
          const s = route.summary;
          const dist = (s.totalDistance/1000).toFixed(2);
          const min = Math.round(s.totalTime/60);
          const hrs = Math.floor(min/60), m = min%60;
          const tstr = hrs ? `${hrs} ชม. ${m} นาที` : `${m} นาที`;
          const label = idx===0?'เส้นทางหลัก':`เส้นทางสำรอง ${idx}`;
          showInstruction.innerHTML += `<div><strong>${label}</strong><br>ระยะทาง: ${dist} กม.<br>เวลา: ${tstr}</div><br>`;
          const mid = route.coordinates[Math.floor(route.coordinates.length/2)];
          L.popup().setLatLng(mid)
            .setContent(`<strong>${label}</strong><br>ระยะทาง: ${dist} กม.<br>เวลา: ${tstr}`)
            .openOn(map);
        });
      }).addTo(map);
    }

    function resetAll(){
      mode='idle'; routeBtn.textContent='ค้นหาเส้นทาง';
      waypoints=[]; markers.forEach(m=>map.removeLayer(m)); markers=[];
      coordInputs.innerHTML=''; showInstruction.innerHTML='';
      if (routeControl) map.removeControl(routeControl), routeControl=null;
    }
  </script>
</body>
</html>

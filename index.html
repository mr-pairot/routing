<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>Leaflet Routing Map++</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

  <style>
    #map {
      height: 100vh;
      cursor: default;
    }

    button {
      font-family: 'Sarabun', sans-serif !important;
    }
    .leaflet-popup-content {
      font-family: 'Sarabun', sans-serif;
      font-size: 12px;
    }
    .leaflet-routing-container {
      background-color: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      font-family: 'Sarabun', sans-serif;
      font-size: 12px;
      padding: 10px;
      width: 270px;
      border: 1px solid #e0e0e0;
    }
    .leaflet-routing-container h2 {
      font-size: 12px;
      color: #0047ab;
      font-weight: bold;
    }
    .leaflet-routing-container-hide {
      width: 32px;
      height: 32px;
    }
    .leaflet-routing-collapse-btn {
      background-image: url('img/routing.png') !important;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
    }

    .floating-panel {
      position: absolute;
      top: 18px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      width: 170px;
      font-family: 'Sarabun', sans-serif;
      font-size: 12px;
    }
    .floating-panel input {
      width: 100%;
      margin-bottom: 8px;
      padding: 5px;
      border: 1px solid #ccc;
    }
    .remove-btn {
      float: right;
      color: red;
      cursor: pointer;
    }
    .instruction {
      margin-top: 10px;
      color: #0000ff;
      font-weight: bold;
    }
  </style>

  <script>
    const cRoute1 = "#0000ff";
    const cRoute2 = "red";
    const cRoute3 = "#f39c12";
    const routeColors = [cRoute1, cRoute2, cRoute3];

    const mainRouteStyles = [
      { color: 'white', weight: 8, opacity: 0.8 },
      { color: cRoute1, weight: 3, opacity: 0.8 }
    ];

    const altRouteStyles = [
      [
        { color: 'white', weight: 6, opacity: 0.8 },
        { color: cRoute2, weight: 3, opacity: 0.8 }
      ],
      [
        { color: 'white', weight: 6, opacity: 0.8 },
        { color: cRoute3, weight: 3, opacity: 0.8 }
      ]
    ];
  </script>
</head>
<body>
  <div id="map"></div>
  <div class="floating-panel" id="control-panel">
    <button id="routeBtn">ค้นหาเส้นทาง</button>
    <div id="coord-inputs"></div>
    <div id="showInstruction" class="instruction"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <script>
    const map = L.map("map").setView([16.439810, 102.829446], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    let routeControl = null;
    let waypoints = [];
    let markers = [];
    let mode = "idle";

    
    const routeBtn = document.getElementById("routeBtn");
    const coordInputs = document.getElementById("coord-inputs");
    const showInstruction = document.getElementById("showInstruction");
    

    routeBtn.addEventListener("click", () => {
      if (mode === "idle") {
        mode = "selecting";
        routeBtn.textContent = "รีเซ็ต";
        waypoints = [];
        markers.forEach((m) => map.removeLayer(m));
        markers = [];
        coordInputs.innerHTML = "";
        showInstruction.innerHTML = "คลิกจุดเริ่มต้น แล้วคลิกจุดหมาย จากนั้นค่อยเลือกจุดทางผ่านหรือปรับลากเปลี่ยนเส้นทาง";
        if (routeControl) {
          map.removeControl(routeControl);
          routeControl = null;
        }
      } else {
        resetAll();
      }
    });

map.on("click", (e) => {
  if (mode !== "selecting") return;
  if (waypoints.length >= 3) return; // จำกัดแค่ 3 จุด

  const marker = L.marker(e.latlng, { draggable: true }).addTo(map);

  if (waypoints.length === 0) {
    // จุดเริ่มต้น
    waypoints.push(e.latlng);
    markers.push(marker);
  } else if (waypoints.length === 1) {
    // จุดหมาย (ชั่วคราว)
    waypoints.push(e.latlng);
    markers.push(marker);
  } else if (waypoints.length === 2) {
    // เพิ่มจุดที่ 3 → เป็น "ทางผ่าน" แทรกที่ index 1
    waypoints.splice(1, 0, e.latlng);
    markers.splice(1, 0, marker);
  }

  updateInputs();

  // ตั้งค่าการลาก
  markers.forEach((m, idx) => {
    m.off("dragend").on("dragend", () => {
      waypoints[idx] = m.getLatLng();
      updateInputs();
      drawRoute();
    });
  });

  drawRoute();
});


function updateInputs() {
  coordInputs.innerHTML = "";
  waypoints.forEach((pt, i) => {
    const row = document.createElement("div");

    let label = "";
    if (i === 0) {
      label = "จุดเริ่ม :";
    } else if (i === waypoints.length - 1) {
      label = "จุดหมาย :";
    } else {
      label = "ทางผ่าน :";
    }

    // เฉพาะทางผ่าน (index = 1) ที่มีปุ่มลบ
    const showRemove = waypoints.length === 3 && i === 1;

    row.innerHTML = `
      <label>${label}</label>
      <input type="text" value="${pt.lat.toFixed(6)}, ${pt.lng.toFixed(6)}" data-idx="${i}">
      ${
        showRemove
          ? '<span class="remove-btn" onclick="removeVia(' + i + ')">✖</span>'
          : ""
      }
    `;
    coordInputs.appendChild(row);
  });

  coordInputs.querySelectorAll("input").forEach((input) => {
    input.addEventListener("change", (e) => {
      const idx = +e.target.dataset.idx;
      const [lat, lng] = e.target.value.split(",").map((v) => parseFloat(v));
      if (!isNaN(lat) && !isNaN(lng)) {
        waypoints[idx] = L.latLng(lat, lng);
        markers[idx].setLatLng(waypoints[idx]);
        drawRoute();
      }
    });
  });
}




    function removeVia(index) {
      map.removeLayer(markers[index]);
      markers.splice(index, 1);
      waypoints.splice(index, 1);
      updateInputs();
      drawRoute();
    }

    function drawRoute() {
      if (waypoints.length < 2) return;
      if (routeControl) map.removeControl(routeControl);

      routeControl = L.Routing.control({
        waypoints: waypoints,
        routeWhileDragging: true,
        show: false,
        collapsible: true,
        router: L.Routing.osrmv1({
          serviceUrl: "https://router.project-osrm.org/route/v1",
        }),
        createMarker: () => null,
        showAlternatives: true,
        lineOptions: {
          styles: mainRouteStyles
        },
        altLineOptions: [
          { styles: altRouteStyles[0] },
          { styles: altRouteStyles[1] }
        ]
      })
      .on("routesfound", function (e) {
        const popupGroup = L.layerGroup().addTo(map);
        showInstruction.innerHTML = "";
        e.routes.forEach((route, idx) => {
          const summary = route.summary;
          const distance = (summary.totalDistance / 1000).toFixed(2);
          const timeMin = Math.round(summary.totalTime / 60);
          const hrs = Math.floor(timeMin / 60);
          const mins = timeMin % 60;
          const timeStr = hrs ? `${hrs} ชม. ${mins} นาที` : `${mins} นาที`;
          const label = idx === 0 ? "เส้นทางหลัก" : `เส้นทางสำรอง ${idx}`;
          const midLatLng = route.coordinates[Math.floor(route.coordinates.length / 2)];
          const popup = L.popup()
            .setLatLng(midLatLng)
            .setContent(`<strong>${label}</strong><br>ระยะทาง: ${distance} กม.<br>เวลา: ${timeStr}`)
            .openOn(map);
          popupGroup.addLayer(popup);

          showInstruction.innerHTML += `<div style="color: ${routeColors[idx]}"><strong>${label}</strong><br>ระยะทาง: ${distance} กม.<br>เวลา: ${timeStr}</div><br>`;
        });

        routeControl._popupGroup = popupGroup;
      })
      .addTo(map);
    }

    function resetAll() {
      mode = "idle";
      routeBtn.textContent = "ค้นหาเส้นทาง";
      waypoints = [];
      markers.forEach((m) => map.removeLayer(m));
      markers = [];
      coordInputs.innerHTML = "";
      showInstruction.innerHTML = "";
      if (routeControl) {
        if (routeControl._popupGroup) map.removeLayer(routeControl._popupGroup);
        map.removeControl(routeControl);
        routeControl = null;
      }
    }

  </script>
</body>
</html>

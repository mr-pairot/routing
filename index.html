<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Leaflet Routing ‡∏û‡∏£‡πâ‡∏≠‡∏° Form ‡∏õ‡πâ‡∏≠‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

  <style>
    body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { height:60vh; }
    #form { padding:10px; background:#f8f9fa; }
    #form label { display:block; margin-top:8px; }
    #form input { width:200px; margin-right:8px; }
    .wp-row { margin-bottom:4px; }
    .btn-del { color:red; cursor:pointer; margin-left:4px; }
    #instruction { margin:10px 0; color:#0d47a1; }
    #controlBtn { padding:8px 14px; background:#1976d2; color:#fff; border:none; border-radius:4px; cursor:pointer; }
  </style>
</head>
<body>

<div id="form">
  <div class="wp-row">
    <label>‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:
      <input type="number" id="lat0" step="any" placeholder="lat">
      <input type="number" id="lng0" step="any" placeholder="lng">
    </label>
  </div>
  <div class="wp-row">
    <label>‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢:
      <input type="number" id="lat1" step="any" placeholder="lat">
      <input type="number" id="lng1" step="any" placeholder="lng">
    </label>
  </div>
  <div id="viaRows"></div>
  <button id="controlBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
  <div id="instruction">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script>
  // ---- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ----
  const MAX_VIAS = 2;
  const lineStyles = {
    main: { styles:[{ color:'blue', weight:5 }] },
    alt1: { styles:[{ color:'deepskyblue', weight:4 }] },
    alt2: { styles:[{ color:'gold', weight:4 }] }
  };

  // ---- ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ----
  let waypoints = [];
  let routingControl = null;
  let selecting = false;

  // ---- DOM refs ----
  const btn = document.getElementById('controlBtn');
  const inst = document.getElementById('instruction');
  const viaRows = document.getElementById('viaRows');
  const lat0 = document.getElementById('lat0');
  const lng0 = document.getElementById('lng0');
  const lat1 = document.getElementById('lat1');
  const lng1 = document.getElementById('lng1');

  const map = L.map('map').setView([13.75,100.5],10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // ---- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢ ----
  function resetAll(){
    selecting = false;
    waypoints = [];
    viaRows.innerHTML = '';
    lat0.value = lng0.value = lat1.value = lng1.value = '';
    inst.textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á';
    btn.textContent = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á';
    if(routingControl) map.removeControl(routingControl);
  }

  function updateInputs(){
    if(waypoints[0]){
      lat0.value=waypoints[0].lat.toFixed(6);
      lng0.value=waypoints[0].lng.toFixed(6);
    }
    if(waypoints[1]){
      lat1.value=waypoints[1].lat.toFixed(6);
      lng1.value=waypoints[1].lng.toFixed(6);
    }
    viaRows.innerHTML = '';
    for(let i=2;i<waypoints.length;i++){
      const idx = i-2;
      const row = document.createElement('div');
      row.className='wp-row';
      row.innerHTML = `
        ‡∏à‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô ${idx+1}:
        <input type="number" step="any" value="${waypoints[i].lat.toFixed(6)}" id="viaLat${idx}">
        <input type="number" step="any" value="${waypoints[i].lng.toFixed(6)}" id="viaLng${idx}">
        <span class="btn-del" data-idx="${i}">&times;</span>
      `;
      viaRows.appendChild(row);
    }
  }

  function showInstruction(msg, isRoute){
    inst.innerHTML = msg;
    inst.style.color = isRoute ? '#0b3d91' : '#0d47a1';
  }

  function drawRoute(){
    if(routingControl) map.removeControl(routingControl);
    routingControl = L.Routing.control({
      waypoints,
      routeWhileDragging:true,
      draggableWaypoints:true,
      showAlternatives:true,
      lineOptions:lineStyles.main,
      altLineOptions:[lineStyles.alt1, lineStyles.alt2],
      createMarker:(i,wp,nWps)=>{
        const lbl = i===0?'üö© ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô':
                    i===1?'üèÅ ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢':
                    `‡∏à‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô ${i-1}`;
        return L.marker(wp.latLng,{draggable:true})
          .bindPopup(`<div class="custom">${lbl}</div>`);
      }
    })
    .on('routesfound',e=>{
      let html='';
      e.routes.forEach((r,i)=>{
        const d=(r.summary.totalDistance/1000).toFixed(2);
        const tmin = Math.round(r.summary.totalTime/60);
        const h = Math.floor(tmin/60), m=tmin%60;
        const label = i===0?'‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å':'‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á '+i;
        html+=`${label}: ${d} ‡∏Å‡∏°. ‡πÄ‡∏ß‡∏•‡∏≤: ${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ<br>`;
      });
      showInstruction(html,true);
    })
    .on('waypointschanged',()=>showInstruction('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà...',false))
    .addTo(map);

    updateInputs();
  }

  // ---- event listeners ----
  btn.onclick = ()=>{
    if(btn.textContent==='‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á'){
      selecting=true;
      resetAll();
      btn.textContent='‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï';
      showInstruction('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á',false);
    } else resetAll();
  };

  map.on('click',e=>{
    if(!selecting) return;
    if(waypoints.length===0){
      waypoints.push(e.latlng);
    } else if(waypoints.length===1){
      waypoints.push(e.latlng);
    } else if(waypoints.length<MAX_VIAS+2){
      waypoints.splice(waypoints.length-1,0,e.latlng);
    }
    if(waypoints.length>=2) drawRoute();
  });

  // delete via button
  viaRows.onclick = e=>{
    if(e.target.classList.contains('btn-del')){
      const idx = parseInt(e.target.dataset.idx);
      waypoints.splice(idx,1);
      drawRoute();
    }
  };

  // input change events
  ['lat0','lng0','lat1','lng1'].forEach(id=>{
    document.getElementById(id).onchange=e=>{
      const val=parseFloat(e.target.value);
      const i = id.endsWith('0')?0:1;
      waypoints[i] = L.latLng(
        parseFloat(document.getElementById(`lat${i}`).value),
        parseFloat(document.getElementById(`lng${i}`).value)
      );
      if(waypoints.length>=2) drawRoute();
    };
  });

  viaRows.addEventListener('change', e=>{
    if(e.target.id.startsWith('viaLat')||e.target.id.startsWith('viaLng')){
      const idx = parseInt(e.target.id.slice(6))+2;
      const lat = parseFloat(document.getElementById(`viaLat${idx-2}`).value);
      const lng = parseFloat(document.getElementById(`viaLng${idx-2}`).value);
      waypoints[idx] = L.latLng(lat,lng);
      drawRoute();
    }
  });

</script>
</body>
</html>
